name: Build

on:
  push:
    branches:
      - main
  release:
    types:
      - created

concurrency:
  group: ${{ github.event_name == 'release' && format('release-{0}', github.event.release.tag_name) || format('edge-{0}', github.ref_name) }}
  cancel-in-progress: ${{ github.event_name == 'push' }}

# Minimal permissions for pushing images to GHCR
permissions:
  contents: read
  packages: write

env:
  IMAGE_NAME: aoirint/ffmpeg
  GHCR_IMAGE_NAME: ghcr.io/aoirint/ffmpeg

jobs:
  build-docker:
    strategy:
      fail-fast: false
      matrix:
        include:
          -
            variant: 'ubuntu'
            is_default_tag: 'true'
            base_image: 'ubuntu:24.04'
            ffmpeg_repository_url: 'https://git.ffmpeg.org/ffmpeg.git'
            ffmpeg_version: 'n7.1.3'
            enable_nvcodec: '0'
          -
            variant: 'nvidia'
            is_default_tag: 'false'
            base_image: 'nvcr.io/nvidia/cuda:12.8.1-cudnn-devel-ubuntu24.04'
            ffmpeg_repository_url: 'https://git.ffmpeg.org/ffmpeg.git'
            ffmpeg_version: 'n7.1.3'
            enable_nvcodec: '1'
          -
            variant: 'ubuntu-aoirint'
            is_default_tag: 'false'
            base_image: 'ubuntu:24.04'
            ffmpeg_repository_url: 'https://github.com/aoirint/FFmpeg.git'
            ffmpeg_version: '7.1.3-aoirint.1'
            enable_nvcodec: '0'

    runs-on: ubuntu-latest

    steps:
      # Checkout repository
      - name: Checkout
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2

      # Require v-prefixed release tags
      - name: Validate release tag prefix
        if: ${{ github.event_name == 'release' }}
        run: |-
          if [[ "${{ github.event.release.tag_name }}" != v* ]]; then
            echo "Release tag must start with 'v': ${{ github.event.release.tag_name }}"
            exit 1
          fi

      - name: Derive tag naming
        id: tagvars
        run: |-
          # タグの構成要素をまとめて生成する。
          # 仕様:
          # - バージョン: v<version>-<variant>
          # - edge: edge-<variant>
          # - latest: <variant>
          # - default latest: latest（ubuntu のみ）
          # 実装:
          # - variant_tag_latest: <variant>
          # - default_tag_latest: latest（ubuntu のみ）

          # variant タグの生成
          if [[ "${{ matrix.variant }}" != "" ]]; then
            echo "variant_tag_prefix=${{ matrix.variant }}-" >> "$GITHUB_OUTPUT"
            echo "variant_tag_suffix=-${{ matrix.variant }}" >> "$GITHUB_OUTPUT"
          else
            echo "variant_tag_prefix=" >> "$GITHUB_OUTPUT"
            echo "variant_tag_suffix=" >> "$GITHUB_OUTPUT"
          fi

          # latest タグの生成
          if [[ "${{ matrix.variant }}" != "" ]]; then
            echo "variant_tag_latest=${{ matrix.variant }}" >> "$GITHUB_OUTPUT"
          else
            echo "variant_tag_latest=latest" >> "$GITHUB_OUTPUT"
          fi

          # default latest タグの生成
          if [[ "${{ matrix.is_default_tag }}" == "true" ]]; then
            echo "default_tag_latest=latest" >> "$GITHUB_OUTPUT"
          else
            echo "default_tag_latest=" >> "$GITHUB_OUTPUT"
          fi

      # Enable Buildx for cache and multi-platform builds
      - name: Setup Docker Buildx
        id: buildx
        uses: docker/setup-buildx-action@8d2750c68a42422c14e847fe6c8ac0403b4cbd6f # v3.12.0

      # Authenticate to Docker Hub
      - name: Login to Docker Hub
        uses: docker/login-action@c94ce9fb468520275223c153574b00df6fe4bcc9 # v3.7.0
        with:
          username: ${{ vars.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      # Authenticate to GHCR
      - name: Login to GHCR
        uses: docker/login-action@c94ce9fb468520275223c153574b00df6fe4bcc9 # v3.7.0
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      # Generate tags, labels, and annotations
      - name: Docker metadata
        id: meta
        uses: docker/metadata-action@c299e40c65443455700f0fdfc63efafe5b349051 # v5.10.0
        with:
          images: |
            ${{ env.IMAGE_NAME }}
            ${{ env.GHCR_IMAGE_NAME }}
          # Disable auto-latest to control it explicitly
          flavor: |
            latest=false
          tags: |
            # edge は main ブランチの継続ビルド用タグ（edge-<variant>）
            type=raw,value=${{ format('edge{0}', steps.tagvars.outputs.variant_tag_suffix) }},enable=${{ github.event_name == 'push' }}
            # バージョンは v<version>-<variant> 形式
            type=raw,value=${{ format('{0}{1}', github.event.release.tag_name, steps.tagvars.outputs.variant_tag_suffix) }},enable=${{ github.event_name == 'release' }}
            # latest はプレリリースを除外したリリースのみ
            type=raw,value=${{ steps.tagvars.outputs.variant_tag_latest }},enable=${{ github.event_name == 'release' && !github.event.release.prerelease }}
            # default は ubuntu の別名として ffmpeg:* を生成する
            type=raw,value=edge,enable=${{ matrix.is_default_tag == 'true' && github.event_name == 'push' }}
            type=raw,value=${{ github.event.release.tag_name }},enable=${{ matrix.is_default_tag == 'true' && github.event_name == 'release' }}
            type=raw,value=${{ steps.tagvars.outputs.default_tag_latest }},enable=${{ matrix.is_default_tag == 'true' && github.event_name == 'release' && !github.event.release.prerelease }}

      # Choose cache tags for edge vs release tags
      - name: Derive build cache refs
        id: cache
        run: |-
          # buildcache は edge と latest の2系統に分ける。
          # edge 系は main ブランチの継続ビルドで更新する。
          if [[ "${{ github.event_name }}" == "release" && "${{ github.event.release.prerelease }}" == "false" ]]; then
            echo "cache_from=type=registry,ref=${{ env.GHCR_IMAGE_NAME }}:edge${{ steps.tagvars.outputs.variant_tag_suffix }}-buildcache" >> "$GITHUB_OUTPUT"
            echo "cache_from=type=registry,ref=${{ env.GHCR_IMAGE_NAME }}:${{ steps.tagvars.outputs.variant_tag_prefix }}buildcache" >> "$GITHUB_OUTPUT"
            echo "cache_to=type=registry,ref=${{ env.GHCR_IMAGE_NAME }}:${{ steps.tagvars.outputs.variant_tag_prefix }}buildcache,mode=max" >> "$GITHUB_OUTPUT"
          else
            echo "cache_from=type=registry,ref=${{ env.GHCR_IMAGE_NAME }}:edge${{ steps.tagvars.outputs.variant_tag_suffix }}-buildcache" >> "$GITHUB_OUTPUT"
            echo "cache_to=type=registry,ref=${{ env.GHCR_IMAGE_NAME }}:edge${{ steps.tagvars.outputs.variant_tag_suffix }}-buildcache,mode=max" >> "$GITHUB_OUTPUT"
          fi

      # Build and push images
      - name: Build and Deploy Docker image
        uses: docker/build-push-action@263435318d21b8e681c14492fe198d362a7d2c83 # v6.18.0
        with:
          context: .
          builder: ${{ steps.buildx.outputs.name }}
          file: ./Dockerfile
          push: true
          build-args: |
            BASE_IMAGE=${{ matrix.base_image }}
            FFMPEG_REPOSITORY_URL=${{ matrix.ffmpeg_repository_url }}
            FFMPEG_VERSION=${{ matrix.ffmpeg_version }}
            ENABLE_NVCODEC=${{ matrix.enable_nvcodec }}
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          annotations: ${{ steps.meta.outputs.annotations }}
          cache-from: ${{ steps.cache.outputs.cache_from }}
          cache-to: ${{ steps.cache.outputs.cache_to }}
